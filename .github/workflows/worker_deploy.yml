name: Handle worker updates

on:
    push:
        branches:
            - main
        paths:
            - "worker/**"

jobs:
    deploy:
        name: Deploy worker
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4
            - name: Write the SSH key
              run: |
                mkdir -p ~/.ssh
                echo "$SSH_KEY" > ~/.ssh/id_rsa
                chmod 600 ~/.ssh/id_rsa
              env:
                SSH_KEY: ${{ secrets.SSH_KEY }}
            - uses: ruby/setup-ruby@v1
              with:
                ruby-version: "3.3"
            - run: gem install kamal
            - run: cd worker && kamal setup
              name: Run kamal setup
              env:
                GITHUB_ACTOR: ${{ github.actor }}
                GITHUB_TOKEN: ${{ github.token }}
                SERVER_HOSTNAME: ${{ secrets.SERVER_HOSTNAME }}
                SERVER_IP: ${{ secrets.SERVER_IP }}
                PG_CONNECTION_STRING: ${{ secrets.PG_CONNECTION_STRING }}
                HTTP_KEY: ${{ secrets.HTTP_KEY }}
